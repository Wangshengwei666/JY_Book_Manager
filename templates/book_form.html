{% extends "base.html" %}

{% block title %}{% if action == 'create' %}添加图书{% else %}编辑图书{% endif %} - JY图书管理系统{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="bi bi-{% if action == 'create' %}plus-circle{% else %}pencil{% endif %}"></i>
                    {% if action == 'create' %}添加新图书{% else %}编辑图书{% endif %}
                </h4>
            </div>
            <div class="card-body">
                <form id="bookForm">
                    {% if action == 'edit' %}
                    <input type="hidden" id="book_id" name="book_id" value="{{ book.book_id }}">
                    {% endif %}
                    
                    <div class="row g-3">
                        <!-- 图书ID -->
                        <div class="col-md-6">
                            <label for="book_id_input" class="form-label">
                                图书ID <span class="text-danger">*</span>
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="book_id_input" 
                                   name="book_id" 
                                   maxlength="8"
                                   value="{% if book %}{{ book.book_id }}{% endif %}"
                                   {% if action == 'edit' %}readonly{% endif %}
                                   required>
                            <div class="form-text">最多8个字符</div>
                            <div class="invalid-feedback"></div>
                        </div>

                        <!-- ISBN -->
                        <div class="col-md-6">
                            <label for="book_isbn" class="form-label">
                                ISBN <span class="text-danger">*</span>
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="book_isbn" 
                                   name="book_isbn" 
                                   maxlength="17"
                                   value="{% if book %}{{ book.book_isbn }}{% endif %}"
                                   required>
                            <div class="form-text">最多17个字符</div>
                            <div class="invalid-feedback"></div>
                        </div>

                        <!-- 图书名称 -->
                        <div class="col-md-12">
                            <label for="book_name" class="form-label">
                                图书名称 <span class="text-danger">*</span>
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="book_name" 
                                   name="book_name" 
                                   maxlength="50"
                                   value="{% if book %}{{ book.book_name }}{% endif %}"
                                   required>
                            <div class="invalid-feedback"></div>
                        </div>

                        <!-- 作者 -->
                        <div class="col-md-6">
                            <label for="book_author" class="form-label">
                                作者 <span class="text-danger">*</span>
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="book_author" 
                                   name="book_author" 
                                   maxlength="10"
                                   value="{% if book %}{{ book.book_author }}{% endif %}"
                                   required>
                            <div class="invalid-feedback"></div>
                        </div>

                        <!-- 出版社 -->
                        <div class="col-md-6">
                            <label for="book_publisher" class="form-label">
                                出版社 <span class="text-danger">*</span>
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="book_publisher" 
                                   name="book_publisher" 
                                   maxlength="50"
                                   value="{% if book %}{{ book.book_publisher }}{% endif %}"
                                   required>
                            <div class="invalid-feedback"></div>
                        </div>

                        <!-- 价格 -->
                        <div class="col-md-6">
                            <label for="book_price" class="form-label">
                                价格 <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">¥</span>
                                <input type="number" 
                                       class="form-control" 
                                       id="book_price" 
                                       name="book_price" 
                                       step="0.01" 
                                       min="0"
                                       value="{% if book %}{{ book.book_price }}{% endif %}"
                                       required>
                            </div>
                            <div class="invalid-feedback"></div>
                        </div>

                        <!-- 借阅次数 -->
                        <div class="col-md-6">
                            <label for="interview_times" class="form-label">
                                借阅次数 <span class="text-danger">*</span>
                            </label>
                            <input type="number" 
                                   class="form-control" 
                                   id="interview_times" 
                                   name="interview_times" 
                                   min="0"
                                   value="{% if book %}{{ book.interview_times }}{% endif %}"
                                   required>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>

                    <div class="mt-4 d-flex justify-content-between">
                        <a href="{{ url_for('index') }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> 返回列表
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> 
                            {% if action == 'create' %}创建图书{% else %}保存修改{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    const form = $('#bookForm');
    const action = '{{ action }}';
    
    form.on('submit', function(e) {
        e.preventDefault();
        
        // 清除之前的验证状态
        form.find('.is-invalid').removeClass('is-invalid');
        
        // 收集表单数据
        const formData = {
            book_name: $('#book_name').val().trim(),
            book_isbn: $('#book_isbn').val().trim(),
            book_author: $('#book_author').val().trim(),
            book_publisher: $('#book_publisher').val().trim(),
            book_price: parseFloat($('#book_price').val()),
            interview_times: parseInt($('#interview_times').val())
        };
        
        // 前端验证
        let isValid = true;
        
        if (action === 'create') {
            formData.book_id = $('#book_id_input').val().trim();
            if (!formData.book_id) {
                showFieldError('book_id_input', '图书ID不能为空');
                isValid = false;
            } else if (formData.book_id.length > 8) {
                showFieldError('book_id_input', '图书ID不能超过8个字符');
                isValid = false;
            }
        }
        
        if (!formData.book_name) {
            showFieldError('book_name', '图书名称不能为空');
            isValid = false;
        }
        
        if (!formData.book_isbn) {
            showFieldError('book_isbn', 'ISBN不能为空');
            isValid = false;
        } else if (formData.book_isbn.length > 17) {
            showFieldError('book_isbn', 'ISBN不能超过17个字符');
            isValid = false;
        }
        
        if (!formData.book_author) {
            showFieldError('book_author', '作者不能为空');
            isValid = false;
        }
        
        if (!formData.book_publisher) {
            showFieldError('book_publisher', '出版社不能为空');
            isValid = false;
        }
        
        if (isNaN(formData.book_price) || formData.book_price < 0) {
            showFieldError('book_price', '请输入有效的价格');
            isValid = false;
        }
        
        if (isNaN(formData.interview_times) || formData.interview_times < 0) {
            showFieldError('interview_times', '请输入有效的借阅次数');
            isValid = false;
        }
        
        if (!isValid) {
            return;
        }
        
        // 提交数据
        const url = action === 'create' 
            ? '/api/books' 
            : '/api/books/' + $('#book_id').val();
        const method = action === 'create' ? 'POST' : 'PUT';
        
        // 显示加载状态
        const submitBtn = form.find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>提交中...');
        
        $.ajax({
            url: url,
            type: method,
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                if (response.success) {
                    showToast(response.message || '操作成功！', 'success');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1000);
                } else {
                    showToast('操作失败: ' + response.message, 'error');
                    submitBtn.prop('disabled', false).html(originalText);
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON || {};
                showToast('操作失败: ' + (response.message || '服务器错误'), 'error');
                submitBtn.prop('disabled', false).html(originalText);
            }
        });
    });
    
    // 实时验证
    $('#book_id_input, #book_name, #book_isbn, #book_author, #book_publisher, #book_price, #interview_times').on('blur', function() {
        validateField($(this));
    });
    
    function validateField(field) {
        const fieldId = field.attr('id');
        const value = field.val().trim();
        
        field.removeClass('is-invalid is-valid');
        
        // 图书ID验证
        if (fieldId === 'book_id_input' && action === 'create') {
            if (!value) {
                showFieldError('book_id_input', '图书ID不能为空');
                return false;
            } else if (value.length > 8) {
                showFieldError('book_id_input', '图书ID不能超过8个字符');
                return false;
            } else {
                field.addClass('is-valid');
            }
        }
        
        // 图书名称验证
        if (fieldId === 'book_name') {
            if (!value) {
                showFieldError('book_name', '图书名称不能为空');
                return false;
            } else {
                field.addClass('is-valid');
            }
        }
        
        // ISBN验证
        if (fieldId === 'book_isbn') {
            if (!value) {
                showFieldError('book_isbn', 'ISBN不能为空');
                return false;
            } else if (value.length > 17) {
                showFieldError('book_isbn', 'ISBN不能超过17个字符');
                return false;
            } else {
                field.addClass('is-valid');
            }
        }
        
        // 作者验证
        if (fieldId === 'book_author') {
            if (!value) {
                showFieldError('book_author', '作者不能为空');
                return false;
            } else {
                field.addClass('is-valid');
            }
        }
        
        // 出版社验证
        if (fieldId === 'book_publisher') {
            if (!value) {
                showFieldError('book_publisher', '出版社不能为空');
                return false;
            } else {
                field.addClass('is-valid');
            }
        }
        
        // 价格验证
        if (fieldId === 'book_price') {
            const price = parseFloat(value);
            if (isNaN(price) || price < 0) {
                showFieldError('book_price', '请输入有效的价格');
                return false;
            } else {
                field.addClass('is-valid');
            }
        }
        
        // 借阅次数验证
        if (fieldId === 'interview_times') {
            const times = parseInt(value);
            if (isNaN(times) || times < 0) {
                showFieldError('interview_times', '请输入有效的借阅次数');
                return false;
            } else {
                field.addClass('is-valid');
            }
        }
        
        return true;
    }
    
    function showFieldError(fieldId, message) {
        const field = $('#' + fieldId);
        field.addClass('is-invalid');
        field.siblings('.invalid-feedback').text(message);
    }
});
</script>
{% endblock %}

